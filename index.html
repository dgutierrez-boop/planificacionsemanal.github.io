<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Tablero de Mantenimiento - Semana 41</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        /* Base: Inter font, DEEP BLACK/BRONZE background */
        body { 
            font-family: 'Inter', sans-serif; 
            /* Fondo negro muy oscuro con un sutil degradado de bronce */
            background-image: radial-gradient(at 0% 0%, rgba(139, 69, 19, 0.2) 0%, transparent 50%), radial-gradient(at 100% 100%, rgba(184, 134, 11, 0.2) 0%, transparent 50%);
            background-color: #000000; /* Negro puro */
        }
        
        /* Bronze Container General Style */
        .bronze-container {
            /* Simula una placa de bronce oscuro */
            background-color: #2c251f; /* Tono marrón/negro oscuro */
            /* Borde dorado sutil */
            border: 1px solid #4a4030;
            /* Sombra exterior pesada y sutil brillo interior */
            box-shadow: 
                0 6px 15px rgba(0, 0, 0, 0.7), /* Sombra exterior para profundidad */
                inset 0 0 10px rgba(255, 215, 0, 0.05); /* Brillo interior sutil */
            border-radius: 0.75rem; 
            transition: box-shadow 0.3s ease-in-out;
        }

        /* Filter Button Active State */
        .active-filter { 
            /* Bronce brillante activo */
            background-color: #FFD700 !important; /* Gold */
            color: #1a1a1a !important; 
            box-shadow: 0 0 15px rgba(255,215,0,0.8), 0 0 30px rgba(255,215,0,0.4); 
        }
        
        /* Task Card Styles - PLACAS DE BRONCE */
        .task-card { 
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out; 
            /* Color base de bronce gastado */
            background-color: #3b3026; /* Marrón oscuro / bronce mate */
            border: 1px solid #6b5c47; /* Borde más definido */
            /* Sombra para simular elevación */
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.5), 0 12px 30px rgba(0, 0, 0, 0.7); 
            min-height: 120px; 
            border-radius: 0.75rem;
            cursor: pointer; /* Indica que es clickeable */
        }
        .task-card:hover { 
            transform: translateY(-5px); 
            /* Sombra más pronunciada al flotar */
            box-shadow: 0 10px 25px rgba(0,0,0,0.9), 0 0 5px rgba(255,215,0,0.3); 
        } 
        
        /* Critical ATRASADO Card Styles - ÓXIDO/CORROSIÓN */
        .card-atrasado { 
            /* Fondo de óxido rojo oscuro para alarma */
            background-color: #4f1d1d !important; /* Rojo/Marrón de óxido */
            border-color: #ef4444 !important; 
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.5), 0 0 40px rgba(239, 68, 68, 0.2); 
        }
        .card-atrasado:hover { box-shadow: 0 10px 25px rgba(0,0,0,0.9), 0 0 40px rgba(239, 68, 68, 0.7); }


        /* Week Highlight Animation (Bronze Pulse) */
        @keyframes pulse-bg { 
            0% { background-color: #2c251f; } 
            50% { background-color: #4b3d29; } /* Tono bronce más claro */
            100% { background-color: #2c251f; } 
        }
        .week-highlight { 
            animation: pulse-bg 5s infinite ease-in-out; 
        }
        .hidden { display: none; }
        
        /* Luminous Tag Styles - Brillo sobre el metal */
        .finalizado-tag, .atrasado-tag, .reprogramado-tag, .programado-tag {
            font-size: 1rem; 
            font-weight: 700; 
            line-height: 1.5rem; 
            animation: pulse-glow 1.5s infinite alternate;
        }

        /* Specific Tag Colors: Ajustados para resaltar en el tema Bronce */
        .finalizado-tag { color: #4ade80; text-shadow: 0 0 6px #4ade80, 0 0 12px rgba(74, 222, 128, 0.7); } /* Verde Brillante */
        .atrasado-tag { color: #ef4444; text-shadow: 0 0 6px #ef4444, 0 0 12px rgba(239, 68, 68, 0.7); } /* Rojo de Emergencia (Crítico por atraso) */
        .reprogramado-tag { color: #f87171; text-shadow: 0 0 6px #f87171, 0 0 12px rgba(248, 113, 113, 0.7); } /* Rojo Claro/Rosa para Advertencia */
        .programado-tag { color: #38bdf8; text-shadow: 0 0 6px #38bdf8, 0 0 12px rgba(56, 189, 248, 0.7); } /* Azul Luminoso */

        @keyframes pulse-glow {
            from { opacity: 0.7; }
            to { opacity: 1.0; }
        }

        /* Responsive adjustments for Filter buttons on small screens */
        #filter-container {
            justify-content: center; 
            overflow-x: auto; 
            white-space: nowrap; 
            -webkit-overflow-scrolling: touch;
        }
        .filter-btn {
             flex-shrink: 0; 
             text-align: center; 
             /* Botones con fondo de bronce ligeramente más claro */
             background-color: #4b3d29; /* Bronce mate */
             transition: background-color 0.2s, box-shadow 0.2s, transform 0.1s;
             box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        }
        .filter-btn:hover {
             background-color: #6b5c47;
             transform: translateY(-2px);
             box-shadow: 0 4px 8px rgba(0, 0, 0, 0.7);
        }
    </style>
</head>
<body class="text-slate-200 antialiased">

    <div class="w-full max-w-full px-4 md:px-8 mx-auto">
        <header class="text-center mb-8 pt-4"> 
            <h1 class="text-4xl md:text-5xl font-black uppercase text-amber-500 tracking-wider" style="text-shadow: 2px 2px #1a1a1a;">PLANIFICACIÓN MANTENIMIENTO</h1>
            <div class="inline-block mt-4 p-2 md:p-3 rounded-xl week-highlight bronze-container border-none">
                <!-- TÍTULO DE BRONCE -->
                <p class="text-2xl md:text-3xl font-extrabold text-amber-300">Semana 41 (03 Oct - 10 Oct, 2025)</p>
            </div>
        </header>

        <!-- BOTÓN FLOTANTE (ENGRANAJE) -->
        <button id="gear-btn" class="loader-toggle-btn p-3 bronze-container rounded-full shadow-xl hover:bg-slate-600 transition-colors text-2xl fixed top-4 right-4 z-50 text-amber-500" title="Mostrar Herramienta de Carga">
            ⚙️
        </button>

        <!-- SECCIÓN DE CARGA DE DATOS (OCULTA POR DEFECTO) -->
        <section id="data-loader" class="bronze-container hidden mb-8 p-4 md:p-6 rounded-xl shadow-inner w-full mx-auto">
            <h2 class="text-xl font-bold text-amber-400 mb-3 border-b border-gray-700 pb-2">Herramientas de Carga de Datos (Firebase)</h2>
            <p class="text-gray-400 mb-3 text-sm">Pega la lista de tareas (JSON) aquí para **SOBRESCRIBIR** la planificación en la nube (Firebase).</p>
            <textarea id="task-input" rows="6" class="w-full p-3 bg-black/70 text-amber-300 rounded-lg border border-gray-700 focus:ring-amber-500 focus:border-amber-500 font-mono text-xs"></textarea>
            <button id="load-tasks-btn" class="mt-3 w-full px-4 py-2 bg-green-700 text-white font-bold rounded-lg hover:bg-green-600 transition-colors shadow-md">Guardar y Actualizar Tablero (Firebase)</button>
            <div id="load-status" class="mt-3 text-center text-sm font-semibold hidden"></div>
        </section>

        <!-- SECCIÓN DE CONTROLES Y FILTROS -->
        <section id="controls" class="mb-8">
            <!-- FILTROS DE DÍA -->
            <div id="filter-container" class="bronze-container flex flex-wrap justify-center gap-2 md:gap-3 p-3 rounded-xl w-full mx-auto"></div>
        </section>

        <!-- INICIO DEL CONTENIDO PRINCIPAL -->
        <main>
            <div class="mb-6 text-center">
                <h2 class="text-2xl font-bold text-amber-500 mb-2">Tareas Programadas</h2>
                <p class="text-gray-400">Selecciona un día para filtrar las tareas. Actualmente mostrando: <span id="current-filter-display" class="font-bold text-amber-300">Todos</span></p>
            </div>
            <!-- Responsive Grid -->
            <div id="tasks-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 pb-8"></div>
        </main>
    </div>

    <!-- MODAL DE CONTRASEÑA -->
    <div id="password-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 hidden">
        <!-- Estilo bronce para el modal -->
        <div class="bronze-container p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h2 class="text-xl font-bold text-amber-400 mb-4">🔐 Ingresar Contraseña</h2>
            <input id="password-input" type="password" placeholder="Contraseña" class="w-full p-2 rounded bg-black/70 border border-gray-600 text-amber-200 focus:outline-none focus:ring-2 focus:ring-amber-500 mb-4" />
            <div class="flex justify-end gap-2">
                <button id="password-cancel" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-500 transition-colors">Cancelar</button>
                <button id="password-ok" class="px-4 py-2 bg-amber-600 text-black font-semibold rounded hover:bg-amber-500 transition-colors">Aceptar</button>
            </div>
        </div>
    </div>
    
    <!-- Info del usuario y la conexión a la base de datos -->
    <footer class="text-center text-xs text-gray-600 p-2 fixed bottom-0 w-full bg-black/50">
        Conectado como ID de Usuario: <span id="user-id-display" class="font-mono text-gray-400">Cargando...</span> | Fuente de datos: Firebase Firestore
    </footer>

    <script type="module">
        // Importar las librerías de Firebase (v11.6.1)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, query, updateDoc, writeBatch, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIGURACIÓN DE FIREBASE (Variables globales proporcionadas por el entorno)
        let firebaseConfig, appId, initialAuthToken;
        try {
            firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        } catch (e) {
            console.error("Error al parsear la configuración de Firebase:", e);
        }

        // Inicialización de Firebase
        let app, db, auth;
        let tasksCollectionRef;
        let userId = 'anonimo'; // Valor por defecto

        // CONSTANTES
        const ACCESS_CODE = '2305';
        const FIRESTORE_PATH = `/artifacts/${appId}/public/data/tasks`;
        const DEFAULT_TASKS_DATA = [
            { id: 't1', equipo: 'EQUIPOS', tarea: 'INSPECCION DE BALDES', dia: 'MARTES 07', estado: 'PROGRAMADO' },
            { id: 't2', equipo: 'M208', tarea: 'PM 5 MÁS KOMTRAX', dia: 'LUNES 06', estado: 'PROGRAMADO' },
            { id: 't3', equipo: 'M205', tarea: 'PM6 + CONTROL DE FUGAS', dia: 'JUEVES 09', estado: 'PROGRAMADO' },
            { id: 't4', equipo: 'M445', tarea: 'PM X ENGRASE', dia: 'VIERNES 03', estado: 'PROGRAMADO' },
            { id: 't5', equipo: 'M448', tarea: 'PM X ENGRASE REALIZADO', dia: 'VIERNES 03', estado: 'FINALIZADO' },
            { id: 't6', equipo: 'M517', tarea: 'PM 3 ENGRASE', dia: 'SABADO 04', estado: 'PROGRAMADO' },
            { id: 't7', equipo: 'M452', tarea: 'PM X ENGRASE', dia: 'VIERNES 03', estado: 'PROGRAMADO' },
            { id: 't8', equipo: 'M639', tarea: 'VERIFICAR RIPPER BAJA SOLO ATRASADO', dia: 'LUNES 06', estado: 'ATRASADO' },
            { id: 't9', equipo: 'M207', tarea: 'SOLDADURA EN BALDE REPROGRAMAR', dia: 'MIERCOLES 08', estado: 'REPROGRAMADO' },
            { id: 't10', equipo: 'M207', tarea: 'PM 1 ENGRASE', dia: 'DOMINGO 05', estado: 'PROGRAMADO' },
            { id: 't11', equipo: 'M102', tarea: 'PM3 ENGRASE REALIZADO', dia: 'VIERNES 03', estado: 'FINALIZADO' }, 
            { id: 't12', equipo: 'M209', tarea: 'CONTROL KONTRAX SULLAIR', dia: 'MARTES 07', estado: 'PROGRAMADO' },
            { id: 't13', equipo: 'M209', tarea: 'ROTAR NEUMÁTICOS DE POS 3Y4 A POS 1Y2 POR MEDIDA DE DESGASTE', dia: 'MIERCOLES 08', estado: 'PROGRAMADO' },
            { id: 't14', equipo: 'M209', tarea: 'COLOCAR NEUMÁTICOS RETIRADOS DE POS 1Y2 DE LA 206 EN LA POS 3Y4', dia: 'JUEVES 09', estado: 'PROGRAMADO' },
            { id: 't15', equipo: 'M205', tarea: 'CONTROL KOMTRAX SULLAIR', dia: 'LUNES 06', estado: 'PROGRAMADO' },
            { id: 't16', equipo: 'M205', tarea: 'COLOCAR NEUMÁTICOS RETIRADOS DE POS 1 Y 2 DE LA 209 EN LA POS. 3 Y 4 DE LA M205', dia: 'JUEVES 09', estado: 'PROGRAMADO' },
            { equipo: 'ME14', tarea: 'CONTROL KOMTRAX', dia: 'MIERCOLES 08', estado: 'PROGRAMADO' }
        ];

        // ELEMENTOS DOM
        const gearBtn = document.getElementById('gear-btn');
        const dataLoaderSection = document.getElementById('data-loader');
        const passwordModal = document.getElementById('password-modal');
        const passwordInput = document.getElementById('password-input');
        const passwordOk = document.getElementById('password-ok');
        const passwordCancel = document.getElementById('password-cancel');
        const taskInput = document.getElementById('task-input');
        const loadTasksBtn = document.getElementById('load-tasks-btn');
        const loadStatus = document.getElementById('load-status');
        const filterContainer = document.getElementById('filter-container');
        const tasksGrid = document.getElementById('tasks-grid');
        const currentFilterDisplay = document.getElementById('current-filter-display');
        const userIdDisplay = document.getElementById('user-id-display');
        // const searchInput = document.getElementById('search-input'); // Removido


        // Estado del Tablero
        let tasksData = [];
        let currentFilter = 'TODOS';
        
        // DÍAS ORDENADOS
        const days = [
            'Todos', 
            'VIERNES 03', 
            'SABADO 04', 
            'DOMINGO 05', 
            'LUNES 06', 
            'MARTES 07', 
            'MIERCOLES 08', 
            'JUEVES 09'
        ];


        // --- FIREBASE FUNCTIONS ---

        async function initializeFirebase() {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config no disponible. Usando datos por defecto.");
                tasksData = normalizeTasks(DEFAULT_TASKS_DATA);
                setupFilters();
                return;
            }
            
            try {
                // setLogLevel('Debug');
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                // tasksCollectionRef apunta a la colección pública de tareas de la app
                tasksCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'tasks');

                // Autenticación
                await new Promise((resolve) => {
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            userIdDisplay.textContent = userId;
                            resolve();
                        } else {
                            // Intentar iniciar sesión con token o anónimamente
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                            // onAuthStateChanged se disparará de nuevo con el usuario, si fue exitoso
                        }
                    });
                });

                // Iniciar la escucha en tiempo real de la base de datos
                setupRealtimeListener();

            } catch (error) {
                console.error("Error al inicializar Firebase o autenticar:", error);
                userIdDisplay.textContent = 'Error de conexión';
                // Cargar datos por defecto si falla la conexión
                tasksData = normalizeTasks(DEFAULT_TASKS_DATA);
                setupFilters();
            }
        }
        
        function setupRealtimeListener() {
            const q = query(tasksCollectionRef);
            
            onSnapshot(q, (snapshot) => {
                const fetchedTasks = [];
                let isDataLoaded = false;
                
                snapshot.docs.forEach(doc => {
                    fetchedTasks.push({ id: doc.id, ...doc.data() });
                    isDataLoaded = true;
                });

                if (!isDataLoaded && tasksData.length === 0) {
                    console.log("No hay tareas en Firestore. Cargando las tareas por defecto...");
                    // Si la base de datos está vacía, la llenamos con las tareas por defecto (solo si el array local también está vacío)
                    saveTasksToFirestore(DEFAULT_TASKS_DATA);
                } else {
                    tasksData = normalizeTasks(fetchedTasks);
                    setupFilters(); // Re-renderiza con la nueva data
                    console.log(`Tareas actualizadas: ${tasksData.length}`);
                }
            }, (error) => {
                console.error("Error en el listener de Firestore:", error);
                // Si hay error en la escucha, forzamos la carga de data por defecto
                tasksData = normalizeTasks(DEFAULT_TASKS_DATA);
                setupFilters();
            });
        }
        
        function normalizeTasks(tasks) {
            return tasks.map(task => {
                const diaUpper = (task.dia || '').toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                // Asegurar que tengan ID y estado
                const id = task.id || crypto.randomUUID();
                const estado = (task.estado || 'PROGRAMADO').toUpperCase();
                
                return {
                    ...task,
                    id: id,
                    equipo: (task.equipo || '').toUpperCase(),
                    dia: diaUpper,
                    tarea: (task.tarea || '').toUpperCase(),
                    estado: estado,
                }
            });
        }
        
        // Guarda un array completo de tareas en Firestore (SOBREESCRIBE la colección)
        async function saveTasksToFirestore(newTasks) {
            if (!db) return showStatus('❌ Error: Firebase no inicializado.', false);
            
            try {
                // Obtener todos los documentos actuales para eliminarlos
                const currentDocs = await getDocs(query(tasksCollectionRef));
                const batch = writeBatch(db);

                // 1. Eliminar documentos existentes
                currentDocs.forEach(doc => {
                    batch.delete(doc.ref);
                });

                // 2. Añadir los nuevos documentos
                newTasks.forEach((task, index) => {
                    // Usar un doc() con un ID predefinido o generar uno si no existe
                    const docId = task.id || `task_${index}_${crypto.randomUUID()}`;
                    const taskRef = doc(tasksCollectionRef, docId);
                    
                    // Asegurar que el objeto a guardar no tiene el campo 'id' duplicado
                    const { id, ...dataToSave } = task;
                    
                    batch.set(taskRef, dataToSave);
                });

                await batch.commit();
                showStatus(`✅ ¡${newTasks.length} tareas actualizadas en la nube!`, true);
                // El listener onSnapshot se encargará del re-render
            } catch (e) {
                console.error("Error al guardar tareas en Firestore:", e);
                showStatus('❌ Error al guardar en Firebase: ' + e.message, false);
            }
        }
        
        // Alterna el estado de una sola tarea
        async function toggleTaskStatus(taskId) {
            if (!db) return console.error('Firebase no inicializado para actualizar tarea.');
            
            try {
                const task = tasksData.find(t => t.id === taskId);
                if (!task) return;

                const newEstado = task.estado === 'FINALIZADO' ? 'PROGRAMADO' : 'FINALIZADO';
                const taskRef = doc(tasksCollectionRef, taskId);
                
                await updateDoc(taskRef, {
                    estado: newEstado,
                    fecha_mod: new Date().toISOString(),
                    user_mod: userId // Opcional: registrar quién lo modificó
                });
                // El onSnapshot se encargará del re-renderizado
            } catch (e) {
                console.error("Error al alternar estado de tarea:", e);
                showStatus('❌ Error al actualizar estado: ' + e.message, false);
            }
        }


        // --- DOM MANIPULATION & LOGIC ---
        
        // Manejador del botón de carga de JSON
        loadTasksBtn.addEventListener('click', async () => {
            try {
                const val = taskInput.value.trim();
                const parsed = JSON.parse(val);
                if (!Array.isArray(parsed)) throw new Error('El JSON debe ser un array de objetos.');
                
                // Normalizar la data antes de guardar en Firebase
                const normalizedTasks = normalizeTasks(parsed);

                // Guardar en Firebase (Esto disparará el onSnapshot y el re-render)
                await saveTasksToFirestore(normalizedTasks);

            } catch (e) {
                showStatus('❌ Error: ' + e.message, false);
            }
        });
        
        // Removida: searchInput.addEventListener('input', ...)

        function showStatus(msg, ok) {
            loadStatus.textContent = msg;
            loadStatus.className = ok ? 'mt-3 text-center text-sm font-semibold text-green-400' : 'mt-3 text-center text-sm font-semibold text-red-400';
            loadStatus.style.display = 'block';
            setTimeout(() => { loadStatus.style.display = 'none'; }, 4000);
        }

        // RENDER DE TARJETAS (Modificado para usar 'estado' y ser clickeable)
        function renderCards(filteredTasks) {
            tasksGrid.innerHTML = '';
            if (!filteredTasks || filteredTasks.length === 0) {
                tasksGrid.innerHTML = `<div class="col-span-full text-center py-10">
                    <p class="text-gray-500 text-lg">No hay tareas programadas para el día seleccionado.</p>
                </div>`;
                return;
            }

            filteredTasks.forEach(task => {
                // Colores ajustados a BRONCE
                const equipoColorClass = 'text-amber-400'; 
                const tareaColorClass = 'text-gray-300'; 
                const fechaBgClass = 'bg-gray-800/70'; 
                const fechaTextColorClass = 'text-amber-300'; 
                
                let statusTag = '';
                let cardClassExtra = '';
                
                // Lógica para determinar el estado
                const estado = (task.estado || 'PROGRAMADO').toUpperCase();

                if (estado === 'FINALIZADO') {
                    statusTag = `<span class="finalizado-tag">FINALIZADO</span>`;
                } else if (estado === 'ATRASADO') {
                    statusTag = `<span class="atrasado-tag">¡ATRASADO!</span>`;
                    cardClassExtra = ' card-atrasado border-red-500';
                } else if (estado === 'REPROGRAMADO') {
                    statusTag = `<span class="reprogramado-tag">REPROGRAMADO</span>`;
                } else {
                    statusTag = `<span class="programado-tag">PROGRAMADO</span>`;
                }

                const card = document.createElement('div');
                card.className = `task-card rounded-xl p-5 shadow-lg flex flex-col justify-between${cardClassExtra}`; 
                card.dataset.taskId = task.id; // Añadir ID de Firebase para clickear

                card.innerHTML = `
                    <div>
                        <div class="flex justify-between items-center mb-3">
                            <div class="flex items-center space-x-2">
                                <h3 class="text-2xl font-black ${equipoColorClass}">${escapeHtml(task.equipo || '')}</h3>
                                ${statusTag}
                            </div>
                            <span class="text-xs font-medium ${fechaBgClass} ${fechaTextColorClass} px-2 py-1 rounded">${escapeHtml(task.dia || '')}</span>
                        </div>
                        <p class="font-medium ${tareaColorClass} mb-4">${escapeHtml(task.tarea || '')}</p>
                    </div>
                `;
                
                // Evento click para alternar estado
                card.addEventListener('click', () => {
                    toggleTaskStatus(task.id);
                });

                tasksGrid.appendChild(card);
            });
        }

        // FILTROS
        function setupFilters() {
            if (filterContainer.children.length === 0) {
                 // 1. Crear el filtro de DÍAS (Solo se crea una vez)
                days.forEach((day) => {
                    const button = document.createElement('button');
                    const dayShort = day === 'Todos' ? 'Todos' : day.split(' ')[0].substring(0,3);
                    const dateNum = day === 'Todos' ? '' : (day.split(' ')[1] || '');
                    
                    if (day === 'Todos') {
                        button.innerHTML = `<span class="font-bold">Todos</span>`;
                    } else {
                        button.innerHTML = `<span class="font-bold">${dayShort}</span><span class="text-xs">${dateNum}</span>`;
                    }

                    button.className = 'filter-btn flex flex-col items-center justify-center h-14 w-14 md:h-16 md:w-16 rounded-lg text-amber-200 font-semibold';
                    
                    const dayForFilter = day.toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                    button.dataset.day = dayForFilter; 

                    button.addEventListener('click', () => {
                        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active-filter'));
                        button.classList.add('active-filter');
                        currentFilterDisplay.textContent = day;
                        currentFilter = dayForFilter;
                        filterTasksAndRender();
                    });

                    filterContainer.appendChild(button);
                });
            }

            // Aplicar el filtro actual después de cargar la data
            filterTasksAndRender();
            
            // Re-activar el botón del filtro actual
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active-filter');
                if (btn.dataset.day === currentFilter) {
                    btn.classList.add('active-filter');
                }
            });
        }
        
        function filterTasksAndRender() {
            let filtered = tasksData;

            // 1. Filtrar por día (si no es 'TODOS')
            if (currentFilter !== 'TODOS') {
                filtered = filtered.filter(task => task.dia === currentFilter);
            }

            // 2. Ordenar por índice de día (si el filtro es 'TODOS')
            if (currentFilter === 'TODOS') {
                 const normalizedDays = days.map(d => d.toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""));
                 const allWithIndex = filtered.map(t => ({ ...t, dayIndex: normalizedDays.indexOf(t.dia) }));
                 allWithIndex.sort((a,b) => (a.dayIndex || 0) - (b.dayIndex || 0));
                 filtered = allWithIndex;
            }


            renderCards(filtered);
        }

        // ESCAPAR HTML simple para evitar inyección al render
        function escapeHtml(str) {
            return String(str).replace(/[&<>"']/g, function (m) {
                return ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m];
            });
        }

        // LÓGICA DEL ENGRAJE / MODAL
        function toggleModalOrLoader() {
            if (!dataLoaderSection.classList.contains('hidden')) {
                dataLoaderSection.classList.add('hidden');
                return;
            }
            passwordInput.value = '';
            passwordModal.classList.remove('hidden');
            setTimeout(() => passwordInput.focus(), 50);
        }

        function closePasswordModal() {
            passwordModal.classList.add('hidden');
            passwordInput.value = '';
        }

        function checkPasswordAndOpen() {
            if (passwordInput.value === ACCESS_CODE) {
                closePasswordModal();
                // Al abrir la herramienta de carga, cargamos el JSON actual de las tareas para que pueda editarlo
                taskInput.value = JSON.stringify(tasksData.map(({ id, ...rest }) => ({ ...rest, id })), null, 2);
                dataLoaderSection.classList.remove('hidden');
            } else {
                console.error('❌ Contraseña incorrecta.');
                passwordInput.value = ''; 
                passwordInput.focus();
            }
        }

        // EVENTOS
        gearBtn.addEventListener('click', toggleModalOrLoader);
        passwordOk.addEventListener('click', checkPasswordAndOpen);
        passwordCancel.addEventListener('click', closePasswordModal);

        passwordInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') checkPasswordAndOpen();
            if (e.key === 'Escape') closePasswordModal();
        });

        // Inicialización
        initializeFirebase();

    </script>
</body>
</html>
